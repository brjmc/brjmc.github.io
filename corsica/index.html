<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GR20 Route Planner</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* Basic styling for a clean, accessible interface */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #fafafa;
      color: #333;
    }
    h1, h2 {
      text-align: center;
    }
    .container {
      max-width: 900px;
      margin: auto;
    }
    label, select {
      font-size: 16px;
    }
    select {
      padding: 8px;
      margin-bottom: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    /* Toggle button for refuges */
    #toggleRefugeDisplay {
      display: block;
      margin: 10px auto 20px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .grid button {
      padding: 10px 15px;
      font-size: 14px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .grid button.selected {
      background-color: #007BFF;
      color: #fff;
      border-color: #007BFF;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #f2f2f2;
    }
    /* Map styling */
    #map {
      height: 400px;
      width: 100%;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>GR20 Route Planner</h1>
    <label for="direction">Select Direction:</label>
    <select id="direction">
      <option value="N2S" selected>North-to-South (Starts at Calenzana)</option>
      <option value="S2N">South-to-North (Starts at Conca)</option>
    </select>
    <!-- Toggle Button -->
    <button id="toggleRefugeDisplay">Show Only Selected Refuges</button>

    <div class="grid" id="refugeGrid"></div>

    <h2>Planned Itinerary</h2>
    <table>
      <thead>
        <tr>
          <th>Day</th>
          <th>Start Refuge</th>
          <th>End Refuge</th>
          <th>Distance (km)</th>
          <th>Elevation Gain (m)</th>
          <th>Elevation Loss (m)</th>
          <th>Highlights</th>
        </tr>
      </thead>
      <tbody id="itineraryTable"></tbody>
    </table>

    <div id="map"></div>
  </div>

  <!-- Include Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    /* Data Setup */
    const refugesN2S = [
      "Calenzana",
      "Refuge d'Ortu di u Piobbu",
      "Refuge de Carrozzu",
      "Ascu Stagnu (Haut Asco)",
      "Refuge de Tighjettu",
      "Refuge de Ciottulu di i Mori",
      "Refuge de Manganu",
      "Refuge de Petra Piana",
      "Refuge de l'Onda",
      "Vizzavona",
      "Bergeries d'E Capannelle",
      "Refuge de Prati",
      "Refuge d'Usciolu",
      "Refuge d'Asinau",
      "Refuge de Paliri",
      "Conca"
    ];

    const stagesN2S = [
      { distance: 11, elevationGain: 1450, elevationLoss: 250, highlights: "Calenzana to Refuge d'Ortu di u Piobbu" },
      { distance: 8,  elevationGain: 720,  elevationLoss: 950, highlights: "Ortu di u Piobbu to Refuge de Carrozzu" },
      { distance: 9,  elevationGain: 800,  elevationLoss: 640, highlights: "Carrozzu to Ascu Stagnu" },
      { distance: 9,  elevationGain: 1200, elevationLoss: 1000, highlights: "Ascu Stagnu to Refuge de Tighjettu" },
      { distance: 7,  elevationGain: 700,  elevationLoss: 340, highlights: "Tighjettu to Refuge de Ciottulu di i Mori" },
      { distance: 24, elevationGain: 920,  elevationLoss: 1300, highlights: "Ciottulu di i Mori to Refuge de Manganu" },
      { distance: 8.5, elevationGain: 830,  elevationLoss: 600, highlights: "Manganu to Refuge de Petra Piana" },
      { distance: 10, elevationGain: 390,  elevationLoss: 800, highlights: "Petra Piana to Refuge de l'Onda" },
      { distance: 13, elevationGain: 990,  elevationLoss: 1500, highlights: "L'Onda to Vizzavona" },
      { distance: 16, elevationGain: 1000, elevationLoss: 335,  highlights: "Vizzavona to Bergeries d'E Capannelle" },
      { distance: 14, elevationGain: 320,  elevationLoss: 620,  highlights: "Capannelle to Refuge de Prati" },
      { distance: 16, elevationGain: 1290, elevationLoss: 830,  highlights: "Prati to Refuge d'Usciolu" },
      { distance: 14, elevationGain: 340,  elevationLoss: 640,  highlights: "Usciolu to Refuge d'Asinau" },
      { distance: 9,  elevationGain: 665,  elevationLoss: 545,  highlights: "Asinau to Refuge de Paliri" },
      { distance: 12, elevationGain: 700,  elevationLoss: 1670, highlights: "Paliri to Conca" }
    ];

    // Coordinates for each refuge (North-to-South)
    const coordinatesN2S = [
      {lat: 42.5081, lng: 8.8553},    // Calenzana
      {lat: 42.4653, lng: 8.9069},    // Refuge d'Ortu di u Piobbu
      {lat: 42.4262, lng: 8.9005},    // Refuge de Carrozzu
      {lat: 42.4035, lng: 8.9223},    // Ascu Stagnu (Haut Asco)
      {lat: 42.3623, lng: 8.9088},    // Refuge de Tighjettu
      {lat: 42.3350, lng: 8.8681},    // Refuge de Ciottulu di i Mori
      {lat: 42.2199, lng: 8.9804},    // Refuge de Manganu
      {lat: 42.1981, lng: 9.0524},    // Refuge de Petra Piana
      {lat: 42.1528, lng: 9.0725},    // Refuge de l'Onda
      {lat: 42.1286, lng: 9.1333},    // Vizzavona
      {lat: 42.0779, lng: 9.1497},    // Bergeries d'E Capannelle
      {lat: 42.0086, lng: 9.2183},    // Refuge de Prati
      {lat: 41.9351, lng: 9.2060},    // Refuge d'Usciolu
      {lat: 41.8415, lng: 9.2144},    // Refuge d'Asinau
      {lat: 41.7945, lng: 9.2596},    // Refuge de Paliri
      {lat: 41.7350, lng: 9.3333}     // Conca
    ];

    let currentDirection = "N2S";
    let refuges = [...refugesN2S];
    let stages = [...stagesN2S];
    let coordinates = [...coordinatesN2S];

    // Global toggle: if true, display all refuges; if false, display only markers for selected stops.
    let showAllRefuges = true;

    // Maintain an array of selected stops (indices); initially only the starting refuge.
    let selectedStops = [0];
    // Aggregated leg stats (computed in updateItinerary).
    let aggregatedLegs = [];

    // Define custom icons using L.divIcon.
    const defaultIcon = L.divIcon({
      className: 'custom-marker',
      html: '<div style="width:16px; height:16px; background-color: blue; border-radius: 50%; border: 2px solid white;"></div>',
      iconSize: [16,16],
      iconAnchor: [8,8]
    });
    const selectedIcon = L.divIcon({
      className: 'custom-marker',
      html: '<div style="width:16px; height:16px; background-color: red; border-radius: 50%; border: 2px solid white;"></div>',
      iconSize: [16,16],
      iconAnchor: [8,8]
    });

    function initRefugeGrid() {
      const grid = document.getElementById("refugeGrid");
      grid.innerHTML = "";
      refuges.forEach((refuge, index) => {
        const btn = document.createElement("button");
        btn.textContent = refuge;
        btn.setAttribute("data-index", index);
        btn.addEventListener("click", onRefugeClick);
        grid.appendChild(btn);
      });
      updateGridSelection();
    }

    function updateGridSelection() {
      const buttons = document.querySelectorAll("#refugeGrid button");
      buttons.forEach(btn => {
        const index = parseInt(btn.getAttribute("data-index"));
        if(selectedStops.includes(index)) {
          btn.classList.add("selected");
        } else {
          btn.classList.remove("selected");
        }
      });
    }

    function onRefugeClick(e) {
      const i = parseInt(e.target.getAttribute("data-index"));
      const lastStop = selectedStops[selectedStops.length - 1];
      if (i === lastStop) return;
      if (selectedStops.includes(i)) {
        const pos = selectedStops.indexOf(i);
        selectedStops = selectedStops.slice(0, pos + 1);
      } else {
        if (i > lastStop) {
          selectedStops.push(i);
        } else {
          return;
        }
      }
      updateGridSelection();
      updateItinerary();
    }

    function updateItinerary() {
      const tbody = document.getElementById("itineraryTable");
      tbody.innerHTML = "";
      aggregatedLegs = [];
      for (let k = 0; k < selectedStops.length - 1; k++) {
        const startIndex = selectedStops[k];
        const endIndex = selectedStops[k + 1];
        let totalDistance = 0, totalGain = 0, totalLoss = 0;
        let combinedHighlights = [];
        for (let j = startIndex; j < endIndex; j++) {
          totalDistance += stages[j].distance;
          totalGain += stages[j].elevationGain;
          totalLoss += stages[j].elevationLoss;
          combinedHighlights.push(stages[j].highlights);
        }
        aggregatedLegs.push({
          startIndex,
          endIndex,
          totalDistance,
          totalGain,
          totalLoss,
          combinedHighlights
        });
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${k+1}</td>
          <td>${refuges[startIndex]}</td>
          <td>${refuges[endIndex]}</td>
          <td>${totalDistance}</td>
          <td>${totalGain}</td>
          <td>${totalLoss}</td>
          <td>${combinedHighlights.join(" | ")}</td>
        `;
        tbody.appendChild(row);
      }
      updateMap();
    }

    // Initialize Leaflet map.
    let map = L.map('map').setView([42.64, 8.75], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data &copy; OpenStreetMap contributors'
    }).addTo(map);

    // Layer groups for markers and stage lines.
    let markerLayer = L.layerGroup().addTo(map);
    let legLayer = L.layerGroup().addTo(map);

    // Toggle button event handler.
    document.getElementById("toggleRefugeDisplay").addEventListener("click", function() {
      showAllRefuges = !showAllRefuges;
      this.textContent = showAllRefuges ? "Show Only Selected Refuges" : "Show All Refuges";
      updateMap();
    });

    function updateMap() {
      markerLayer.clearLayers();
      legLayer.clearLayers();

      // Add markers: either for all refuges or only for selected stops.
      if (showAllRefuges) {
        refuges.forEach((refuge, index) => {
          const iconToUse = selectedStops.includes(index) ? selectedIcon : defaultIcon;
          const marker = L.marker(coordinates[index], { icon: iconToUse });
          marker.bindTooltip(refuge, { direction: 'top', permanent: false });
          markerLayer.addLayer(marker);
        });
      } else {
        selectedStops.forEach(index => {
          const marker = L.marker(coordinates[index], { icon: selectedIcon });
          marker.bindTooltip(refuges[index], { direction: 'top', permanent: false });
          markerLayer.addLayer(marker);
        });
      }

      // Draw aggregated legs as separate polylines (all in green).
      aggregatedLegs.forEach((leg) => {
        const legCoords = [
          coordinates[leg.startIndex],
          coordinates[leg.endIndex]
        ];
        const polyline = L.polyline(legCoords, { color: 'green', weight: 5, opacity: 0.8 });
        const tooltipContent = `Distance: ${leg.totalDistance} km<br>Elevation Gain: ${leg.totalGain} m<br>Elevation Loss: ${leg.totalLoss} m`;
        polyline.bindTooltip(tooltipContent, {sticky: true});
        legLayer.addLayer(polyline);
      });

      // Adjust map view to fit the markers in selectedStops.
      const coordsToFit = selectedStops.map(index => coordinates[index]);
      if (coordsToFit.length > 0) {
        const bounds = L.latLngBounds(coordsToFit);
        map.fitBounds(bounds, { padding: [20, 20] });
      }
    }

    // Listen for direction changes.
    document.getElementById("direction").addEventListener("change", function(e) {
      currentDirection = e.target.value;
      if (currentDirection === "N2S") {
        refuges = [...refugesN2S];
        stages = [...stagesN2S];
        coordinates = [...coordinatesN2S];
      } else {
        refuges = [...refugesN2S].reverse();
        stages = stagesN2S.slice().reverse().map(stage => ({
          distance: stage.distance,
          elevationGain: stage.elevationLoss,
          elevationLoss: stage.elevationGain,
          highlights: stage.highlights
        }));
        coordinates = [...coordinatesN2S].reverse();
      }
      selectedStops = [0];
      initRefugeGrid();
      updateItinerary();
    });

    // Initial setup.
    initRefugeGrid();
    updateItinerary();
  </script>
</body>
</html>
